<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StartupSuite â€“ AI Team Platform</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; overflow-x: hidden; }
    .app-container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { width: 280px; background: white; border-right: 1px solid #e0e6ed; padding: 20px 0; overflow-y: auto; }
    .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid #e0e6ed; margin-bottom: 20px; }
    .sidebar-header h2 { font-size: 1.2rem; color: #1a1a1a; margin-bottom: 5px; }
    .sidebar-nav { padding: 0 10px; }
    .nav-item { display: flex; align-items: center; padding: 12px 15px; margin: 5px 0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: #6b7280; font-size: 0.9rem; }
    .nav-item:hover { background: #f3f4f6; color: #374151; }
    .nav-item.active { background: #f0f4ff; color: #4f46e5; border-left: 3px solid #4f46e5; }

    .persona-list { margin-top: 20px; padding: 0 10px; }
    .persona-sidebar-item { display: flex; align-items: center; padding: 10px 15px; margin: 5px 0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
    .persona-sidebar-item:hover { background: #f9fafb; }
    .persona-sidebar-item.active { background: #f0f4ff; }
    .persona-avatar { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.8rem; margin-right: 12px; }
    .persona-info { flex: 1; }
    .persona-name { font-size: 0.9rem; font-weight: 500; color: #1f2937; margin-bottom: 2px; }
    .persona-status { font-size: 0.75rem; color: #6b7280; }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; position: absolute; top: 8px; right: 10px; }
    .status-working { background: #fbbf24; }
    .status-complete { background: #10b981; }
    .status-waiting { background: #ef4444; }
    .status-idle { background: #9ca3af; }

    /* Main */
    .main-content { flex: 1; display: flex; flex-direction: column; }
    .top-header { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; padding: 20px 30px; display: flex; align-items: center; justify-content: space-between; }
    .top-header h1 { font-size: 1.5rem; font-weight: 600; }
    .header-toolbar { display: flex; align-items: center; gap: 12px; }
    .toolbar-group { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); padding: 6px 8px; border-radius: 10px; }
    .toolbar-label { font-size: 0.75rem; opacity: 0.95; }
    .toolbar-chips { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .toolbar-chip { background: rgba(255,255,255,0.22); color: white; border: 1px solid rgba(255,255,255,0.35); padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; cursor: pointer; }
    .toolbar-chip:hover { background: rgba(255,255,255,0.32); }
    .project-selector { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; min-width: 150px; }
    .project-selector option { background: #1f2937; color: white; }
    .header-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 8px 16px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease; }
    .header-btn:hover { background: rgba(255, 255, 255, 0.3); }

    .content-area { flex: 1; padding: 30px; overflow-y: auto; }
    .view-container { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); min-height: calc(100vh - 160px); }
    .view { display: none; padding: 30px; }
    .view.active { display: block; }

    .welcome-section { text-align: center; padding: 60px 40px; }
    .welcome-section h2 { color: #1f2937; font-size: 2rem; font-weight: 600; margin-bottom: 15px; }
    .welcome-section p { font-size: 1.1rem; color: #6b7280; margin-bottom: 20px; }

    .team-selection { margin: 40px 0; }
    .personas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin: 20px 0; }
    .persona-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; background: white; transition: all 0.2s ease; }
    .persona-card:hover { border-color: #8b5cf6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15); }
    .persona-card.selected { border-color: #8b5cf6; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%); }
    .persona-card h4 { color: #1f2937; font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; }
    .persona-card p { color: #6b7280; font-size: 0.9rem; line-height: 1.5; }

    .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 22px; border-radius: 10px; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
    .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { background: #6c757d; }
    .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }

    /* Progress */
    .progress-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 10px 0 30px; }
    .progress-card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.2s ease; position: relative; }
    .progress-card:hover { border-color: #8b5cf6; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1); }
    .progress-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .progress-card h4 { color: #1f2937; font-size: 1rem; font-weight: 600; margin: 0; }
    .progress-percentage { color: #6b7280; font-size: 0.9rem; margin-left: auto; }
    .progress-bar { background: #e1e5e9; height: 8px; border-radius: 4px; overflow: hidden; }
    .progress-fill { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; transition: width 0.3s ease; }

    /* Chat */
    .chat-interface { background: #f8f9fa; border-radius: 15px; padding: 24px; margin: 10px 0 30px; }
    .team-info { background: #e3f2fd; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .team-info h4 { color: #1976d2; margin-bottom: 8px; }
    .chip-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { background: #1976d2; color: white; padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; cursor: pointer; }
    .chip.secondary { background: #6b7280; }
    .chat-messages { max-height: 420px; overflow-y: auto; background: white; border-radius: 10px; padding: 16px; margin: 16px 0; border: 1px solid #e1e5e9; }
    .message { margin-bottom: 16px; padding: 12px; border-radius: 10px; }
    .message.user { background: #e3f2fd; margin-left: 50px; }
    .message.ai { background: #f3e5f5; margin-right: 50px; }
    .message.system { background: #e8f5e8; text-align: center; font-style: italic; }
    .message-header { font-weight: 700; margin-bottom: 6px; color: #333; }
    .message p { margin-bottom: 8px; line-height: 1.6; }
    .message code { background: #f1f5f9; padding: 2px 4px; border-radius: 3px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em; }
    .message strong { font-weight: 600; }
    .message em { font-style: italic; }
    .input-section { display: flex; gap: 12px; margin-top: 10px; }
    .input-section textarea { flex: 1; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px; font-family: inherit; font-size: 1rem; resize: vertical; min-height: 60px; }
    .input-section textarea:focus { outline: none; border-color: #667eea; }

    /* Persona individual */
    .persona-view { padding: 0; }
    .persona-header { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px; }
    .persona-header .persona-avatar { width: 44px; height: 44px; font-size: 1.1rem; }
    .persona-details h3 { color: #1f2937; font-size: 1.15rem; font-weight: 600; margin-bottom: 4px; }
    .persona-details p { color: #6b7280; font-size: 0.9rem; }
    .persona-content { padding: 24px; }
    .persona-thinking { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 18px; }
    .persona-thinking h4 { color: #475569; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 8px; }
    .thinking-content { color: #334155; line-height: 1.6; font-size: 0.95rem; }
    .deliverables-section { margin-top: 18px; }
    .deliverables-section h4 { color: #1f2937; font-size: 1rem; font-weight: 700; margin-bottom: 10px; }
    .deliverable-item { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; }
    .deliverable-item:hover { border-color: #8b5cf6; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1); }
    .deliverable-item h5 { color: #374151; font-size: 0.95rem; font-weight: 700; margin-bottom: 6px; }
    .deliverable-item p { color: #6b7280; font-size: 0.9rem; line-height: 1.5; }
    
    /* Deliverable Modal */
    .deliverable-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; }
    .deliverable-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 30px; max-width: 800px; max-height: 80vh; overflow-y: auto; }
    .deliverable-content h3 { color: #1f2937; margin-bottom: 15px; }
    .deliverable-content h4 { color: #374151; margin: 20px 0 10px 0; }
    .deliverable-content ul { margin-left: 20px; margin-bottom: 15px; }
    .deliverable-content li { margin-bottom: 5px; }
    .close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
    .close-btn:hover { color: #374151; }

    /* Additions: persona actions and follow-up sharing */
    .persona-actions { margin-left: auto; display: flex; gap: 8px; }
    .pill-toggle { display: inline-flex; align-items: center; gap: 8px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 999px; padding: 6px 10px; font-size: 0.8rem; color: #374151; }
    .followup-options { display: flex; align-items: center; gap: 12px; color: #6b7280; font-size: 0.85rem; margin-top: 6px; }

    /* Tweak modal */
    .tweak-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; z-index: 1100; }
    .tweak-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 22px; width: 560px; max-width: 92vw; }
    .tweak-content h3 { margin-bottom: 10px; color: #111827; }
    .tweak-actions { display:flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }
    .tweak-row { margin-top: 10px; color:#6b7280; font-size: 0.9rem; }

    @media (max-width: 768px) {
      .personas-grid { grid-template-columns: 1fr; }
      .input-section { flex-direction: column; }
      .message.user { margin-left: 20px; }
      .message.ai { margin-right: 20px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>StartupSuite</h2>
        <p style="color: #6b7280; font-size: 0.8rem;">AI Team Platform</p>
      </div>
      <div class="sidebar-nav">
        <div class="nav-item active" data-view="overview">ðŸ“Š Dashboard</div>
        <div class="nav-item" data-view="chat">ðŸ’¬ Executive Chat</div>
      </div>
      <div class="persona-list" id="persona-sidebar"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="top-header">
        <h1 id="view-title">Dashboard</h1>
        <div class="header-toolbar">
          <div class="toolbar-group">
            <span class="toolbar-label">Project</span>
            <select id="project-selector" class="project-selector">
              <option value="">Select Project...</option>
              <option value="new">+ New Project</option>
            </select>
          </div>
          <div class="toolbar-group">
            <span class="toolbar-label">Instances</span>
            <div class="toolbar-chips" id="toolbar-instances"></div>
          </div>
          <div class="toolbar-group">
            <span class="toolbar-label">Tasks</span>
            <div class="toolbar-chips" id="toolbar-tasks"></div>
          </div>
          <div style="flex:1 1 auto"></div>
          <button class="header-btn" id="btn-new">New Project</button>
          <button class="header-btn" id="btn-settings">Settings</button>
          <button class="header-btn" id="btn-pause-all">Pause All</button>
          <button class="header-btn" id="btn-resume-all">Resume All</button>
          <button class="header-btn" id="btn-tweak-all">Tweak & Resend</button>
        </div>
      </div>

      <div class="content-area">
        <div class="view-container">
          <!-- Overview -->
          <div class="view active" id="overview-view">
            <div class="welcome-section" id="welcome-section">
              <h2>Welcome to StartupSuite!</h2>
              <p>Get started by creating a new project and assembling your AI team.</p>
              <div style="text-align:center; margin-top: 20px;">
                <button class="btn" id="btn-start-project">Assemble Your Team</button>
              </div>
            </div>
            <div class="project-section" id="project-section" style="display:none;">
              <h2 style="text-align:center; color:#1f2937; margin-bottom: 15px;">Project Dashboard</h2>
              <div style="text-align:center; margin-bottom: 30px;">
                <button class="btn btn-secondary" id="btn-update-team">Update Your Team</button>
                <button class="btn" id="btn-continue-chat" style="margin-left: 10px;">Continue Working</button>
              </div>
            </div>
            <div id="progress-overview-section" style="display:none;">
              <h3 style="color:#1f2937; margin-bottom: 10px;">Project Progress</h3>
              <div class="progress-overview" id="progress-overview"></div>
            </div>
          </div>

          <!-- Setup -->
          <div class="view" id="setup-view">
            <div class="team-selection">
              <h3 style="text-align:center;">Choose Your Team</h3>
              <p style="text-align:center; color:#6b7280; margin-bottom: 20px;">Select the AI personas you want on your team:</p>
              <div class="personas-grid" id="setup-personas-grid"></div>
              <div style="text-align:center; margin-top: 20px;">
                <button class="btn" id="proceed-to-chat" disabled>Start Working</button>
              </div>
            </div>
          </div>

          <!-- Executive Chat -->
          <div class="view" id="chat-view">
            <div class="chat-interface">
              <div class="team-info" id="team-info">
                <h4>Selected Team</h4>
                <div class="chip-row" id="selected-team-chips"></div>
                <div style="height:8px"></div>
                <div class="chip-row" id="linked-instances"></div>
                <div class="chip-row" id="linked-tasks" style="margin-top:6px"></div>
              </div>
              <div class="chat-messages" id="chat-messages">
                <div class="message system"><div class="message-header">System</div>Team initialized. Ready to receive your executive idea.</div>
              </div>
              <div class="input-section">
                <textarea id="executive-input" placeholder="Describe your idea or project..."></textarea>
                <button class="btn" id="btn-send">Send</button>
              </div>
              <div id="action-plan-section" style="display:none;">
                <div class="action-plan" style="background:#fff3cd; border:1px solid #ffeaa7; border-radius:10px; padding:16px; margin: 16px 0;">
                  <h4 style="color:#856404; margin-bottom:8px;">Executive Action Plan</h4>
                  <div id="action-plan-content"></div>
                  <div style="text-align:center; margin-top: 10px;">
                    <button class="btn btn-secondary" id="btn-refine">Refine Plan</button>
                    <button class="btn btn-success" id="btn-approve">Give Green Light</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Persona detail views -->
          <div id="persona-views"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Deliverable Modal -->
  <div class="deliverable-modal" id="deliverable-modal">
    <div class="deliverable-content">
      <button class="close-btn" onclick="closeDeliverableModal()">&times;</button>
      <h3 id="deliverable-title">Deliverable Title</h3>
      <div id="deliverable-body">Deliverable content will appear here...</div>
    </div>
  </div>

  <!-- Tweak & Resend Modal -->
  <div class="tweak-modal" id="tweak-modal">
    <div class="tweak-content">
      <h3 id="tweak-title">Tweak & Resend</h3>
      <textarea id="tweak-input" placeholder="Describe the change or follow-up..." style="width:100%; min-height:120px; border:1px solid #e5e7eb; border-radius:8px; padding:10px; font-family:inherit;"></textarea>
      <div class="tweak-row"><label><input type="checkbox" id="tweak-propagate" checked> Propagate to linked personas</label></div>
      <div class="tweak-actions">
        <button class="header-btn" onclick="closeTweakModal()">Cancel</button>
        <button class="header-btn" id="tweak-submit">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Personas configuration
    const personas = {
      'executive': { name: 'Executive', description: 'Strategic vision and oversight', color: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', shortName: 'EX' },
      'product-manager': { name: 'Product Manager', description: 'Market research and requirements', color: 'linear-gradient(135deg, #06b6d4, #0891b2)', shortName: 'PM' },
      'solution-architect': { name: 'Solution Architect', description: 'Technical design and architecture', color: 'linear-gradient(135deg, #10b981, #059669)', shortName: 'SA' },
      'program-manager': { name: 'Program Manager', description: 'Project planning and task management', color: 'linear-gradient(135deg, #f59e0b, #d97706)', shortName: 'PGM' },
      'design-buddy': { name: 'Design Buddy', description: 'User experience and design', color: 'linear-gradient(135deg, #ec4899, #db2777)', shortName: 'DB' }
    };

    // State
    let selectedPersonas = [];
    let currentView = 'overview';
    let currentProject = null; // {id, name, personas, created}
    let projects = []; // Array of saved projects
    const personaStates = {};
    const instances = []; // {id, personaId, name}
    const tasks = []; // {id, personaId, title}

    // Dependencies
    const defaultDependencies = { executive: [], 'product-manager': ['executive'], 'solution-architect': ['product-manager'], 'program-manager': ['solution-architect'], 'design-buddy': ['product-manager'] };
    let currentDependencies = {};

    Object.keys(personas).forEach(id => {
      personaStates[id] = { status: 'idle', thinking: 'Ready to contribute to the project...', progress: 0, dependencies: [], deliverables: [] };
    });

    // Utilities
    function byId(id) { return document.getElementById(id); }
    function addMessage(sender, content, type='ai') {
      const chatMessages = byId('chat-messages');
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.innerHTML = `<div class="message-header">${sender}</div>${content}`;
      chatMessages.appendChild(message); chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function addPersonaMessage(personaId, sender, content, type='ai') {
      const chatMessages = byId(`${personaId}-chat-messages`);
      if (!chatMessages) return;
      const message = document.createElement('div');
      message.className = `message ${type}`;
      // Convert markdown-like content to HTML
      const formattedContent = formatMarkdown(content);
      message.innerHTML = `<div class="message-header">${sender}</div>${formattedContent}`;
      chatMessages.appendChild(message); 
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function formatMarkdown(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code style="background:#f1f5f9;padding:2px 4px;border-radius:3px;">$1</code>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^/, '<p>')
        .replace(/$/, '</p>');
    }
    
    function sendPersonaMessage(personaId) {
      const input = byId(`${personaId}-input`);
      const message = input.value.trim();
      if (!message) return;
      
      addPersonaMessage(personaId, 'You', message, 'user');
      input.value = '';
      
      const share = byId(`${personaId}-share-linked`);
      if (share && share.checked) {
        propagateUpdateToLinked(personaId, message);
      }
      
      // Simulate AI response
      setTimeout(() => {
        const responses = {
          'product-manager': `Thank you for your question! As your **Product Manager**, I'm analyzing this from a market perspective.\n\nHere's my initial assessment:\n- Market opportunity analysis\n- User persona definition\n- Competitive landscape review\n\nI'll create a comprehensive *Product Requirements Document* based on this input.`,
          'solution-architect': `Great question! From a **technical architecture** standpoint, I need to consider:\n\n\`System scalability requirements\`\n\`Technology stack selection\`\n\`Integration patterns\`\n\nLet me design the optimal solution architecture for this requirement.`,
          'program-manager': `Excellent! As your **Program Manager**, I'll break this down into actionable tasks:\n\n**Phase 1**: Requirements gathering\n**Phase 2**: Design and architecture\n**Phase 3**: Implementation planning\n\nI'll create a detailed project timeline with milestones.`,
          'design-buddy': `Love this direction! From a **UX/UI perspective**, I'm thinking about:\n\n- User journey mapping\n- Interface wireframes\n- Design system components\n\nI'll create mockups that prioritize *user experience* and visual consistency.`,
          'executive': `Excellent strategic thinking! As your **Executive**, I see the bigger picture:\n\n**Key Strategic Objectives:**\n- Market positioning\n- Resource allocation\n- Risk assessment\n\nThis aligns well with our overall business goals and competitive strategy.`
        };
        
        const response = responses[personaId] || `Thank you for your input! I'll work on this and provide detailed analysis shortly.`;
        addPersonaMessage(personaId, personas[personaId].name, response, 'ai');
      }, 1000 + Math.random() * 2000);
    }

    // Views
    function showView(view) {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.view === view));
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      if (view === 'overview') { 
        byId('overview-view').classList.add('active'); 
        byId('view-title').textContent = currentProject ? 'Project Dashboard' : 'Dashboard'; 
        updateDashboardView();
      }
      if (view === 'setup') { byId('setup-view').classList.add('active'); byId('view-title').textContent = 'Team Setup'; renderSetupGrid(); }
      if (view === 'chat') { byId('chat-view').classList.add('active'); byId('view-title').textContent = 'Executive Chat'; renderSelectedTeam(); }
      currentView = view;
    }

    function updateDashboardView() {
      const welcomeSection = byId('welcome-section');
      const projectSection = byId('project-section');
      
      if (currentProject) {
        welcomeSection.style.display = 'none';
        projectSection.style.display = 'block';
      } else {
        welcomeSection.style.display = 'block';
        projectSection.style.display = 'none';
      }
      updateProgressOverview();
    }

    function renderSidebar() {
      const container = byId('persona-sidebar');
      container.innerHTML = Object.keys(personas).map(pid => {
        const p = personas[pid];
        return `
          <div class="persona-sidebar-item" data-persona="${pid}">
            <div class="persona-avatar" style="background:${p.color};">${p.shortName}</div>
            <div class="persona-info">
              <div class="persona-name">${p.name}</div>
              <div class="persona-status" id="${pid}-status">Ready to work</div>
            </div>
            <div class="status-indicator status-idle" id="${pid}-indicator"></div>
          </div>`;
      }).join('');
      container.querySelectorAll('.persona-sidebar-item').forEach(el => {
        el.addEventListener('click', () => {
          const personaId = el.dataset.persona; showPersonaView(personaId);
        })
      })
    }

    function renderSetupGrid() {
      const grid = byId('setup-personas-grid');
      grid.innerHTML = Object.keys(personas).map(pid => {
        const p = personas[pid];
        const isSelected = selectedPersonas.includes(pid);
        return `
          <div class="persona-card ${isSelected ? 'selected' : ''}" data-persona="${pid}">
            <div class="persona-avatar" style="background:${p.color}; width:48px; height:48px; margin:0 auto 10px; font-size:1.1rem;">${p.shortName}</div>
            <h4>${p.name}</h4>
            <p>${p.description}</p>
          </div>`;
      }).join('');
      grid.querySelectorAll('.persona-card').forEach(card => {
        card.addEventListener('click', () => {
          const pid = card.dataset.persona;
          const idx = selectedPersonas.indexOf(pid);
          if (idx > -1) { selectedPersonas.splice(idx, 1); card.classList.remove('selected'); }
          else { selectedPersonas.push(pid); card.classList.add('selected'); }
          byId('proceed-to-chat').disabled = selectedPersonas.length === 0;
        })
      })
    }

    function renderSelectedTeam() {
      byId('selected-team-chips').innerHTML = selectedPersonas.map(pid => `<span class="chip" style="background:#667eea">${personas[pid].name}</span>`).join('');
      renderToolbar();
      renderLinkedChips();
    }

    function renderToolbar() {
      const instC = byId('toolbar-instances');
      const taskC = byId('toolbar-tasks');
      instC.innerHTML = instances.map(inst => `<span class="toolbar-chip" data-inst="${inst.id}">${inst.name}</span>`).join('');
      taskC.innerHTML = tasks.map(t => `<span class="toolbar-chip" data-task="${t.id}">${t.title}</span>`).join('');
      instC.querySelectorAll('[data-inst]').forEach(chip => chip.addEventListener('click', () => {
        const inst = instances.find(i => i.id === chip.dataset.inst); if (inst) showPersonaView(inst.personaId);
      }));
      taskC.querySelectorAll('[data-task]').forEach(chip => chip.addEventListener('click', () => { showView('chat'); }));
    }

    function renderLinkedChips() {
      byId('linked-instances').innerHTML = instances.map(i => `<span class="chip">${i.name}</span>`).join('');
      byId('linked-tasks').innerHTML = tasks.map(t => `<span class="chip secondary">${t.title}</span>`).join('');
    }

    function showPersonaView(personaId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      let view = byId(`${personaId}-persona-view`);
      if (!view) {
        // build view on first access
        const wrapper = document.createElement('div');
        wrapper.className = 'view persona-view';
        wrapper.id = `${personaId}-persona-view`;
        const p = personas[personaId];
        wrapper.innerHTML = `
          <div class="persona-header">
            <div class="persona-avatar" style="background:${p.color};">${p.shortName}</div>
            <div class="persona-details"><h3>${p.name}</h3><p>${p.description}</p></div>
            <div class="persona-actions">
              <button class="header-btn" onclick="interruptPersona('${personaId}')">Pause</button>
              <button class="header-btn" onclick="resumePersona('${personaId}')">Resume</button>
              <button class="header-btn" onclick="openTweakModal('${personaId}')">Tweak & Resend</button>
            </div>
          </div>
          <div class="persona-content">
            <div class="chat-interface" style="margin-bottom: 20px;">
              <div class="chat-messages" id="${personaId}-chat-messages">
                <div class="message system"><div class="message-header">System</div>${p.name} is ready to help with your project.</div>
              </div>
              <div class="input-section">
                <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
                  <textarea id="${personaId}-input" placeholder="Ask ${p.name} anything..."></textarea>
                  <div class="followup-options">
                    <label class="pill-toggle"><input type="checkbox" id="${personaId}-share-linked" checked style="margin-right:6px;"> Share with linked personas</label>
                  </div>
                </div>
                <button class="btn" onclick="sendPersonaMessage('${personaId}')">Send</button>
              </div>
            </div>
            <div class="persona-thinking">
              <h4>Current Status</h4>
              <div class="thinking-content" id="${personaId}-thinking">Ready to contribute to the project...</div>
            </div>
            <div id="${personaId}-dependencies"></div>
            <div class="deliverables-section">
              <h4>Deliverables</h4>
              <div id="${personaId}-deliverables"></div>
            </div>
          </div>`;
        byId('persona-views').appendChild(wrapper);
      }
      byId(`${personaId}-persona-view`).classList.add('active');
      byId('view-title').textContent = personas[personaId].name;
      updatePersonaView(personaId);
      currentView = `${personaId}-persona`;
    }

    function updatePersonaView(personaId) {
      const state = personaStates[personaId];
      const thinkEl = byId(`${personaId}-thinking`); if (thinkEl) thinkEl.textContent = state.thinking;
      const depC = byId(`${personaId}-dependencies`);
      if (depC) {
        depC.innerHTML = state.dependencies.length ? `<div class="persona-thinking" style="background:#FEF3C7;border-color:#F59E0B"><div style="font-weight:700;color:#92400e;margin-bottom:6px;">Waiting for</div><div style="color:#92400e;">${state.dependencies.join(', ')}</div></div>` : '';
      }
      renderDeliverables(personaId);
    }
    
    function renderDeliverables(personaId) {
      const container = byId(`${personaId}-deliverables`);
      if (!container) return;
      
      const deliverables = getPersonaDeliverables(personaId);
      container.innerHTML = deliverables.map(del => `
        <div class="deliverable-item" onclick="openDeliverable('${del.id}', '${del.title}', '${personaId}')">
          <h5>${del.title}</h5>
          <p>${del.description}</p>
        </div>
      `).join('');
    }
    
    function getPersonaDeliverables(personaId) {
      const deliverableMap = {
        'executive': [
          { id: 'vision-doc', title: 'Project Vision Document', description: 'Strategic objectives and high-level project goals' },
          { id: 'strategy-brief', title: 'Strategic Brief', description: 'Market positioning and competitive analysis' }
        ],
        'product-manager': [
          { id: 'market-research', title: 'Market Research Report', description: 'Competitor analysis and market opportunities' },
          { id: 'product-requirements', title: 'Product Requirements Document', description: 'Detailed functional and non-functional requirements' },
          { id: 'user-personas', title: 'User Personas', description: 'Target user profiles and behavior patterns' }
        ],
        'solution-architect': [
          { id: 'system-architecture', title: 'System Architecture Document', description: 'Technical specifications and implementation strategy' },
          { id: 'tech-stack', title: 'Technology Stack Recommendations', description: 'Recommended tools and frameworks for development' }
        ],
        'program-manager': [
          { id: 'project-timeline', title: 'Project Timeline', description: 'Detailed schedule with milestones and deadlines' },
          { id: 'task-breakdown', title: 'Task Breakdown Structure', description: 'Epics and user stories with acceptance criteria' }
        ],
        'design-buddy': [
          { id: 'user-journey', title: 'User Journey Maps', description: 'Detailed user flows and interaction patterns' },
          { id: 'wireframes', title: 'UI Wireframes', description: 'Visual mockups and design system components' }
        ]
      };
      return deliverableMap[personaId] || [];
    }
    
    function openDeliverable(deliverableId, title, personaId) {
      const modal = byId('deliverable-modal');
      const titleEl = byId('deliverable-title');
      const bodyEl = byId('deliverable-body');
      
      titleEl.textContent = title;
      bodyEl.innerHTML = generateDeliverableContent(deliverableId, personaId);
      modal.style.display = 'block';
    }
    
    function closeDeliverableModal() {
      byId('deliverable-modal').style.display = 'none';
    }
    
    function generateDeliverableContent(deliverableId, personaId) {
      const sampleContent = {
        'vision-doc': `
          <h4>Executive Vision</h4>
          <p><strong>Project Objective:</strong> Create an innovative solution that addresses key market needs while maintaining competitive advantage.</p>
          
          <h4>Strategic Goals</h4>
          <ul>
            <li>Capture 15% market share within 18 months</li>
            <li>Achieve break-even by month 12</li>
            <li>Build scalable foundation for future growth</li>
          </ul>
          
          <h4>Success Metrics</h4>
          <p>Key performance indicators include user acquisition rate, revenue growth, and customer satisfaction scores.</p>
        `,
        'market-research': `
          <h4>Market Analysis</h4>
          <p><strong>Market Size:</strong> $2.4B total addressable market with 12% annual growth rate.</p>
          
          <h4>Competitive Landscape</h4>
          <ul>
            <li><strong>Competitor A:</strong> Strong in enterprise, weak in SMB</li>
            <li><strong>Competitor B:</strong> Good UX but limited features</li>
            <li><strong>Market Gap:</strong> No solution addresses both ease-of-use and enterprise features</li>
          </ul>
          
          <h4>Target Users</h4>
          <p>Primary: Small to medium businesses seeking enterprise-grade solutions<br>
          Secondary: Enterprise teams needing simplified workflows</p>
        `,
        'system-architecture': `
          <h4>System Overview</h4>
          <p><strong>Architecture Pattern:</strong> Microservices with event-driven communication</p>
          
          <h4>Technology Stack</h4>
          <ul>
            <li><strong>Frontend:</strong> React with TypeScript</li>
            <li><strong>Backend:</strong> Node.js with Express</li>
            <li><strong>Database:</strong> PostgreSQL with Redis cache</li>
            <li><strong>Infrastructure:</strong> AWS with Kubernetes</li>
          </ul>
          
          <h4>Scalability Considerations</h4>
          <p>Horizontal scaling capabilities, load balancing, and automated failover mechanisms.</p>
        `,
        'project-timeline': `
          <h4>Project Timeline</h4>
          <p><strong>Duration:</strong> 6 months with 3 major phases</p>
          
          <h4>Phase Breakdown</h4>
          <ul>
            <li><strong>Phase 1 (Months 1-2):</strong> Requirements and Design</li>
            <li><strong>Phase 2 (Months 3-4):</strong> Core Development</li>
            <li><strong>Phase 3 (Months 5-6):</strong> Testing and Launch</li>
          </ul>
          
          <h4>Key Milestones</h4>
          <p>MVP completion, beta testing, and production deployment milestones with clear success criteria.</p>
        `,
        'user-journey': `
          <h4>User Journey Analysis</h4>
          <p><strong>Primary User Flow:</strong> Discovery â†’ Evaluation â†’ Onboarding â†’ Active Use</p>
          
          <h4>Key Touchpoints</h4>
          <ul>
            <li><strong>Landing Page:</strong> Clear value proposition</li>
            <li><strong>Sign-up Flow:</strong> Streamlined registration</li>
            <li><strong>First Use:</strong> Guided onboarding experience</li>
            <li><strong>Daily Use:</strong> Efficient workflow patterns</li>
          </ul>
          
          <h4>Pain Points & Solutions</h4>
          <p>Identified friction points in current solutions and proposed UX improvements.</p>
        `
      };
      
      return sampleContent[deliverableId] || `
        <h4>${personas[personaId].name} Deliverable</h4>
        <p>This deliverable contains detailed analysis and recommendations from your ${personas[personaId].name}.</p>
        <p><strong>Status:</strong> In Progress</p>
        <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
        <p>Detailed content will be generated based on your project requirements and persona interactions.</p>
      `;
    }

    function updatePersonaStatus(personaId, status, thinking) {
      personaStates[personaId].status = status; personaStates[personaId].thinking = thinking;
      const st = byId(`${personaId}-status`); if (st) st.textContent = thinking.substring(0, 40) + '...';
      const ind = byId(`${personaId}-indicator`); if (ind) ind.className = `status-indicator status-${status}`;
      if (currentView === `${personaId}-persona`) updatePersonaView(personaId);
      updateProgressOverview();
    }

    function updateProgressOverview() {
      const section = byId('progress-overview-section');
      const container = byId('progress-overview');
      if (!selectedPersonas.length) { section.style.display = 'none'; return; }
      section.style.display = 'block'; container.innerHTML = '';
      selectedPersonas.forEach(pid => {
        const state = personaStates[pid];
        const card = document.createElement('div'); card.className = 'progress-card'; card.onclick = () => showPersonaView(pid);
        card.innerHTML = `
          <div class="progress-card-header">
            <div class="persona-avatar" style="background:${personas[pid].color};">${personas[pid].shortName}</div>
            <h4>${personas[pid].name}</h4>
            <div class="progress-percentage">${state.progress}%</div>
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width:${state.progress}%"></div></div>
          <div class="status" style="margin-top: 10px; color: #6b7280; font-size: 0.9rem;">${state.thinking}</div>`;
        container.appendChild(card);
      })
    }

    function updateProjectSelector() {
      const selector = byId('project-selector');
      selector.innerHTML = '<option value="">Select Project...</option>';
      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        if (currentProject && currentProject.id === project.id) {
          option.selected = true;
        }
        selector.appendChild(option);
      });
      selector.innerHTML += '<option value="new">+ New Project</option>';
    }

    function createNewProject() {
      const projectName = prompt('Enter project name:');
      if (!projectName) return;
      
      const project = {
        id: 'proj_' + Date.now(),
        name: projectName,
        personas: [],
        created: new Date().toISOString()
      };
      
      projects.push(project);
      currentProject = project;
      selectedPersonas = [];
      updateProjectSelector();
      showView('setup');
    }

    function switchProject(projectId) {
      if (projectId === 'new') {
        createNewProject();
        return;
      }
      
      const project = projects.find(p => p.id === projectId);
      if (project) {
        currentProject = project;
        selectedPersonas = [...project.personas];
        updateDashboardView();
        renderSelectedTeam();
        updateProgressOverview();
        renderSidebar();
      } else {
        currentProject = null;
        selectedPersonas = [];
        updateDashboardView();
      }
    }

    // Executive chat flow
    function submitExecutiveIdea() {
      const input = byId('executive-input'); const idea = input.value.trim(); if (!idea) return;
      addMessage('You', idea, 'user'); input.value = '';
      setTimeout(() => generateActionPlan(idea), 800);
    }

    function generateActionPlan(idea) {
      const plans = {
        'product-manager': 'Conduct market research, analyze competitors, define user personas, and create product requirements document',
        'solution-architect': 'Review requirements, design system architecture, create technical specs, and define implementation plan',
        'program-manager': 'Break down requirements into epics and stories, create project timeline, and set up task tracking',
        'design-buddy': 'Create user journey maps, design wireframes, develop UI mockups, and establish design system'
      };
      const tasksPlan = selectedPersonas.filter(p => p !== 'executive').map(pid => ({ persona: personas[pid].name, task: plans[pid] || 'Collaborate with team to support project goals' }));
      const html = `<p>Based on your idea: "${idea}", here's the execution plan:</p><ul>${tasksPlan.map(t => `<li><strong>${t.persona}:</strong> ${t.task}</li>`).join('')}</ul>`;
      byId('action-plan-content').innerHTML = html; byId('action-plan-section').style.display = 'block';
      addMessage('Executive AI', 'I\'ve analyzed your idea and created an action plan. Please review it below and give the green light when ready.');
    }

    function refineActionPlan() {
      addMessage('Executive AI', 'Please describe what you\'d like to change about the current plan, and I\'ll refine it accordingly.');
      byId('executive-input').placeholder = 'Describe changes to the action plan...';
    }

    function approveActionPlan() {
      addMessage('You', 'Action plan approved. Green light given to the team!', 'user');
      addMessage('Executive AI', 'Excellent! I\'m now delegating tasks to the team. Moving to execution phase.');
      setTimeout(() => { showView('overview'); startExecution(); }, 800);
    }

    // Execution orchestration
    function startExecution() {
      setupDependencies();
      updatePersonaStatus('executive', 'working', 'Creating project vision and strategic objectives...');
      if (selectedPersonas.includes('product-manager')) { updatePersonaStatus('product-manager', 'waiting', 'Waiting for executive vision before starting market research...'); personaStates['product-manager'].dependencies = ['Executive vision']; }
      if (selectedPersonas.includes('solution-architect')) { updatePersonaStatus('solution-architect', 'waiting', 'Waiting for product requirements to begin technical design...'); personaStates['solution-architect'].dependencies = ['Product requirements']; }
      if (selectedPersonas.includes('program-manager')) { updatePersonaStatus('program-manager', 'waiting', 'Waiting for technical specifications to create project plan...'); personaStates['program-manager'].dependencies = ['Technical specifications']; }
      if (selectedPersonas.includes('design-buddy')) { updatePersonaStatus('design-buddy', 'waiting', 'Waiting for product requirements to start design work...'); personaStates['design-buddy'].dependencies = ['Product requirements']; }
      simulateWorkflow();
    }

    function setupDependencies() {
      currentDependencies = {};
      selectedPersonas.forEach(pid => { currentDependencies[pid] = (defaultDependencies[pid] || []).filter(d => selectedPersonas.includes(d)); });
      selectedPersonas.forEach(pid => { personaStates[pid].dependencies = (currentDependencies[pid] || []).map(d => personas[d]?.name).filter(Boolean); });
    }

    function simulateWorkflow() {
      simulatePersonaWork('executive', () => {
        if (selectedPersonas.includes('product-manager')) {
          personaStates['product-manager'].dependencies = []; updatePersonaStatus('product-manager','working','Conducting market research and defining requirements...');
          simulatePersonaWork('product-manager', () => {
            if (selectedPersonas.includes('solution-architect')) {
              personaStates['solution-architect'].dependencies = []; updatePersonaStatus('solution-architect','working','Creating technical architecture and system design...');
              simulatePersonaWork('solution-architect', () => {
                if (selectedPersonas.includes('program-manager')) {
                  personaStates['program-manager'].dependencies = []; updatePersonaStatus('program-manager','working','Creating project timeline and task breakdown...');
                  simulatePersonaWork('program-manager', () => { addMessage('System', 'All team members have completed their tasks! Project execution finished successfully.', 'system'); });
                }
              });
            }
            if (selectedPersonas.includes('design-buddy')) {
              personaStates['design-buddy'].dependencies = []; updatePersonaStatus('design-buddy','working','Creating user experience designs and wireframes...');
              simulatePersonaWork('design-buddy');
            }
          });
        }
      });
    }

    function simulatePersonaWork(personaId, onComplete) {
      const defaultSteps = ['Starting analysis...', 'Gathering information...', 'Processing requirements...', 'Creating deliverables...', 'Finalizing work...', 'Task completed!'];
      const state = personaStates[personaId];
      if (!state.work) state.work = { steps: defaultSteps, index: 0, intervalId: null, onComplete: null };
      if (!state.work.steps) state.work.steps = defaultSteps;
      if (typeof state.work.index !== 'number') state.work.index = 0;
      state.work.onComplete = onComplete || state.work.onComplete || null;
      if (state.work.intervalId) { clearInterval(state.work.intervalId); state.work.intervalId = null; }
      state.work.intervalId = setInterval(() => {
        const i = state.work.index;
        const steps = state.work.steps;
        const progress = (i + 1) * (100 / steps.length);
        state.progress = Math.max(0, Math.min(100, Math.round(progress)));
        let thinking = steps[i];
        if (i === steps.length - 1) {
          thinking = 'Task completed! Deliverables ready for review.';
          updatePersonaStatus(personaId, 'complete', thinking);
          clearInterval(state.work.intervalId); state.work.intervalId = null; state.work.index = 0; // reset for next run
          if (state.work.onComplete) state.work.onComplete();
        } else {
          updatePersonaStatus(personaId, 'working', thinking);
          state.work.index = i + 1;
        }
        addMessage(personas[personaId].name, thinking, 'ai');
      }, 1200 + Math.random() * 1200);
    }

    function interruptPersona(personaId) {
      const state = personaStates[personaId];
      if (state?.work?.intervalId) { clearInterval(state.work.intervalId); state.work.intervalId = null; }
      updatePersonaStatus(personaId, 'waiting', 'Paused by user.');
    }

    function resumePersona(personaId) {
      const state = personaStates[personaId];
      if (!state.work) state.work = { steps: null, index: 0, intervalId: null };
      simulatePersonaWork(personaId, state.work.onComplete);
    }

    function restartPersonaWork(personaId, stepsOverride) {
      const state = personaStates[personaId];
      state.progress = 0;
      state.work = { steps: stepsOverride || null, index: 0, intervalId: null, onComplete: null };
      simulatePersonaWork(personaId);
    }

    function getDownstreamPersonas(personaId) {
      // reverse dependency graph
      const downstream = selectedPersonas.filter(pid => (currentDependencies[pid] || []).includes(personaId));
      return downstream;
    }

    function propagateUpdateToLinked(sourcePersonaId, message) {
      const downstream = getDownstreamPersonas(sourcePersonaId);
      downstream.forEach(pid => {
        addPersonaMessage(pid, 'System', `Update from ${personas[sourcePersonaId].name}: ${message}`, 'system');
        updatePersonaStatus(pid, 'working', `Revising deliverables based on ${personas[sourcePersonaId].name}'s update...`);
        const revisionSteps = ['Assessing update...', 'Revising work...', 'Validating changes...', 'Finalizing update...', 'Update integrated'];
        restartPersonaWork(pid, revisionSteps);
      });
    }

    function interruptAll() { selectedPersonas.forEach(pid => interruptPersona(pid)); }
    function resumeAll() { selectedPersonas.forEach(pid => resumePersona(pid)); }

    // Tweak modal handlers
    let tweakTargetPersona = null;
    function openTweakModal(personaId = null) {
      tweakTargetPersona = personaId;
      byId('tweak-title').textContent = personaId ? `Tweak & Resend to ${personas[personaId].name}` : 'Tweak & Resend to Team';
      byId('tweak-input').value = '';
      byId('tweak-modal').style.display = 'block';
    }
    function closeTweakModal() { byId('tweak-modal').style.display = 'none'; tweakTargetPersona = null; }
    function submitTweak() {
      const text = byId('tweak-input').value.trim(); if (!text) { closeTweakModal(); return; }
      const propagate = byId('tweak-propagate').checked;
      if (tweakTargetPersona) {
        addPersonaMessage(tweakTargetPersona, 'You', text, 'user');
        if (propagate) propagateUpdateToLinked(tweakTargetPersona, text);
        restartPersonaWork(tweakTargetPersona);
      } else {
        selectedPersonas.forEach(pid => {
          addPersonaMessage(pid, 'Executive Update', text, 'system');
          restartPersonaWork(pid);
        });
      }
      closeTweakModal();
    }

    // High-level actions
    function proceedToChat() {
      if (!selectedPersonas.length) return; 
      
      // Save project state
      if (currentProject) {
        currentProject.personas = [...selectedPersonas];
      }
      
      showView('chat');
      // Auto-create instances and tasks linked together
      instances.length = 0; tasks.length = 0;
      selectedPersonas.forEach((pid, idx) => {
        const instId = `${pid}-inst-${idx+1}`; instances.push({ id: instId, personaId: pid, name: `${personas[pid].name} ${idx+1}` });
        tasks.push({ id: `${pid}-task-${idx+1}`, personaId: pid, title: `${personas[pid].name} Chat` });
      });
      renderToolbar(); renderLinkedChips(); renderSelectedTeam(); updateProgressOverview();
    }

    function resetWorkflow() {
      selectedPersonas = []; 
      currentProject = null;
      Object.keys(personas).forEach(id => { 
        personaStates[id] = { status: 'idle', thinking: 'Ready to contribute to the project...', progress: 0, dependencies: [], deliverables: [] }; 
        const st = byId(`${id}-status`); if (st) st.textContent = 'Ready to work'; 
        const ind = byId(`${id}-indicator`); if (ind) ind.className = 'status-indicator status-idle'; 
      });
      byId('chat-messages').innerHTML = '<div class="message system"><div class="message-header">System</div>Team initialized. Ready to receive your executive idea.</div>';
      byId('action-plan-section').style.display = 'none'; byId('progress-overview-section').style.display = 'none';
      byId('executive-input').placeholder = 'Describe your idea or project...'; byId('executive-input').value = '';
      byId('proceed-to-chat').disabled = true; instances.length = 0; tasks.length = 0; renderToolbar(); renderLinkedChips();
      updateProjectSelector(); updateDashboardView(); renderSetupGrid(); showView('overview');
    }

    // Event wiring
    document.addEventListener('DOMContentLoaded', () => {
      // Top nav
      document.querySelectorAll('.nav-item').forEach(i => i.addEventListener('click', () => showView(i.dataset.view)));
      byId('btn-new').addEventListener('click', createNewProject);
      byId('btn-start-project').addEventListener('click', () => showView('setup'));
      byId('btn-update-team').addEventListener('click', () => showView('setup'));
      byId('btn-continue-chat').addEventListener('click', () => showView('chat'));
      byId('btn-pause-all').addEventListener('click', interruptAll);
      byId('btn-resume-all').addEventListener('click', resumeAll);
      byId('btn-tweak-all').addEventListener('click', () => openTweakModal(null));

      // Project selector
      byId('project-selector').addEventListener('change', (e) => switchProject(e.target.value));

      // Setup actions
      renderSetupGrid(); renderSidebar();
      byId('proceed-to-chat').addEventListener('click', proceedToChat);

      // Chat actions
      byId('btn-send').addEventListener('click', submitExecutiveIdea);
      byId('btn-refine').addEventListener('click', refineActionPlan);
      byId('btn-approve').addEventListener('click', approveActionPlan);
      byId('tweak-submit').addEventListener('click', submitTweak);

      // Modal close on background click
      byId('deliverable-modal').addEventListener('click', (e) => {
        if (e.target === byId('deliverable-modal')) closeDeliverableModal();
      });
      byId('tweak-modal').addEventListener('click', (e) => {
        if (e.target === byId('tweak-modal')) closeTweakModal();
      });

      updateProjectSelector();
      updateDashboardView();
    });
  </script>
</body>
</html>